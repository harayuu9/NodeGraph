# アーキテクチャ

NodeGraph は、関心の分離（Separation of Concerns）を重視した3層アーキテクチャを採用しています。

## 🏗️ システム構成

プロジェクトは以下の3つの主要コンポーネントで構成されています。

### 1. NodeGraph.Model (コアロジック)
UIや特定のフレームワークに依存しない、純粋な C# ライブラリです。
グラフのデータ構造、実行エンジン、型システム、シリアライゼーションロジックを含みます。

- **依存関係**: なし (標準ライブラリのみ)
- **ターゲット**: .NET 9.0, .NET Standard 2.1

### 2. NodeGraph.Editor (UIアプリケーション)
Avalonia UI を使用したデスクトップアプリケーションです。
Model層のクラスをラップし、MVVMパターンを用いてUIにバインドします。

- **依存関係**: NodeGraph.Model
- **主な機能**:
    - グラフの可視化 (パン/ズーム)
    - ノードの操作 (移動、接続、選択)
    - プロパティ編集
    - Undo/Redo管理

### 3. NodeGraph.Generator (ソース生成)
Roslyn Source Generator を使用して、ノード定義からボイラープレートコードを自動生成します。
これにより、開発者はノードの本質的なロジックの実装に集中できます。

## 🔄 データフロー

### 実行モデル
グラフの実行は `GraphExecutor` クラスが担当します。

1. **トポロジカルソート**: ノード間の依存関係を解析し、実行順序を決定します。循環参照がある場合は検出してエラーとします。
2. **非同期実行**: 各ノードは `Task` として実行されます。依存関係のないノードは並列に実行される可能性があります。
3. **値の伝播**:
    - ノードの実行完了後、`OutputPort` の値が接続された `InputPort` に転送されます。
    - この際、必要に応じて型変換（例: `int` -> `float`）が自動的に行われます。

### データ構造
- **Graph**: ノードのコレクションを管理するコンテナ。
- **Node**: 処理の単位。入力ポート、出力ポート、プロパティを持ちます。
- **Port**: ノード間の接続点。ジェネリクスにより型安全性が保証されています。
    - `InputPort<T>`: 値を受け取るポート。
    - `OutputPort<T>`: 値を出力するポート。

## 💾 メモリ管理

パフォーマンスを最大化するため、以下のようなメモリ最適化が行われています。

- **オブジェクトプーリング**: `List<T>`, `Dictionary<TKey, TValue>`, `HashSet<T>` などのコレクションは、カスタムプール (`NodeGraph.Model.Pool`) から貸し出され、使用後に返却されます。
- **ArrayPool**: 実行エンジン内の一時バッファには `System.Buffers.ArrayPool` が使用されます。
- **構造体の活用**: 頻繁に生成される軽量なオブジェクト（座標やIDなど）には `record struct` を使用し、GCの負荷を軽減しています。
